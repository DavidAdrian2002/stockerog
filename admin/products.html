<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionar Productos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-zinc-950 min-h-screen text-zinc-200">

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-10 py-12 sm:py-16">

  <!-- HEADER -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center 
              mb-12 sm:mb-16 border-b border-zinc-800 pb-6 gap-6">

    <div>
      <h1 class="text-2xl sm:text-3xl font-light tracking-wider text-white uppercase">
        Productos
      </h1>
      <p id="marca-nombre" class="text-xs sm:text-sm text-zinc-400 mt-2 tracking-wide"></p>
    </div>

    <a href="admin.html"
       class="text-sm text-zinc-400 hover:text-amber-500 transition tracking-wide">
      ‚Üê Volver
    </a>
  </div>

  <!-- BOT√ìN AGREGAR -->
  <div class="flex justify-end mb-10 sm:mb-12">
    <button onclick="abrirFormulario()"
      class="w-full sm:w-auto
             bg-amber-500 text-black
             px-6 py-3 rounded-xl
             hover:bg-amber-600 transition
             text-xs sm:text-sm tracking-widest uppercase font-semibold">
      + Agregar Producto
    </button>
  </div>

  <!-- TABLA -->
  <div class="bg-zinc-900 rounded-2xl shadow-2xl shadow-black/40 
              border border-zinc-800 p-4 sm:p-6">

    <h2 class="text-base sm:text-lg font-medium mb-6 text-white tracking-wide">
      Listado de productos
    </h2>

    <!-- Scroll horizontal para m√≥vil -->
    <div class="overflow-x-auto">

      <table class="min-w-[700px] w-full text-sm">

        <thead class="border-b border-zinc-800 text-zinc-400 uppercase tracking-wider text-xs">
          <tr class="text-left">
            <th class="py-3">Imagen</th>
            <th class="py-3">Nombre</th>
            <th class="py-3">Talle</th>
            <th class="py-3">Precio</th>
            <th class="py-3">Stock</th>
            <th class="py-3 text-right">Acciones</th>
          </tr>
        </thead>

        <tbody id="tabla-productos"
               class="divide-y divide-zinc-800">
        </tbody>

      </table>

    </div>
  </div>

  <!-- FORM -->
  <div id="form-container"
       class="hidden mt-12 sm:mt-16
              bg-zinc-900 rounded-2xl shadow-2xl shadow-black/50
              border border-zinc-800
              p-6 sm:p-10 lg:p-12">

    <h2 class="text-lg sm:text-xl font-medium mb-8 sm:mb-10 text-white tracking-wide uppercase">
      Nuevo Producto
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8">

      <input id="prod-nombre" type="text" placeholder="Nombre"
        class="bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3
               text-white text-sm sm:text-base
               focus:outline-none focus:ring-2 focus:ring-amber-500 transition">

      <input id="prod-talle" type="text" placeholder="Talle"
        class="bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3
               text-white text-sm sm:text-base
               focus:outline-none focus:ring-2 focus:ring-amber-500 transition">

      <input id="prod-precio" type="number" placeholder="Precio"
        class="bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3
               text-white text-sm sm:text-base
               focus:outline-none focus:ring-2 focus:ring-amber-500 transition">

      <input id="prod-stock" type="number" placeholder="Stock"
        class="bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3
               text-white text-sm sm:text-base
               focus:outline-none focus:ring-2 focus:ring-amber-500 transition">

      <input id="prod-imagen" type="file" accept="image/*"
        class="bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3
               text-xs sm:text-sm text-zinc-400
               file:bg-amber-500 file:text-black
               file:border-0 file:px-4 file:py-2
               file:rounded-lg file:cursor-pointer
               hover:file:bg-amber-600 transition">
    </div>

    <textarea id="prod-descripcion" placeholder="Descripci√≥n"
      class="w-full mt-6 sm:mt-8 bg-zinc-800 border border-zinc-700 rounded-xl
             px-4 py-3 h-28 sm:h-32 text-white text-sm sm:text-base
             focus:outline-none focus:ring-2 focus:ring-amber-500 transition">
    </textarea>

    <div class="flex flex-col sm:flex-row justify-end mt-8 sm:mt-10 gap-4">

      <button onclick="cerrarFormulario()"
        class="w-full sm:w-auto
               px-6 py-3 border border-zinc-700 rounded-xl
               text-xs sm:text-sm text-zinc-400
               hover:bg-zinc-800 hover:text-white transition">
        Cancelar
      </button>

      <button onclick="guardarProducto()"
        class="w-full sm:w-auto
               bg-amber-500 text-black
               px-8 py-3 rounded-xl
               hover:bg-amber-600 transition
               text-xs sm:text-sm
               tracking-widest uppercase font-semibold">
        Guardar
      </button>

    </div>

  </div>

</div>


<script>

const API = "http://localhost:3000/api";
const urlParams = new URLSearchParams(window.location.search);
const marcaId = urlParams.get("marcaId");

let productoEditandoId = null; // üî• clave para saber si estamos editando

document.addEventListener("DOMContentLoaded", () => {
  if (!marcaId) {
    alert("Marca no especificada");
    return;
  }

  cargarMarca();
  cargarProductos();
});

async function cargarMarca() {
  const res = await fetch(`${API}/marcas/${marcaId}`);
  const marca = await res.json();
  document.getElementById("marca-nombre").textContent = marca.nombre;
}

async function cargarProductos() {
  const res = await fetch(`${API}/productos/marca/${marcaId}`);
  const productos = await res.json();

  const tabla = document.getElementById("tabla-productos");
  tabla.innerHTML = "";

  productos.forEach(prod => {
    tabla.innerHTML += `
      <tr class="border-b">
        <td class="py-3">
          <img src="http://localhost:3000/images/${prod.imagen}" width="50">
        </td>
        <td>${prod.nombre}</td>
        <td>${prod.talle}</td>
        <td>$${prod.precio}</td>
        <td>${prod.stock}</td>
        <td class="text-right space-x-3">

          <button onclick="editarProducto('${prod._id}')"
            class="text-blue-600 hover:underline text-xs">
            Editar
          </button>

          <button onclick="eliminarProducto('${prod._id}')"
            class="text-red-500 hover:underline text-xs">
            Eliminar
          </button>

        </td>
      </tr>
    `;
  });
}

function abrirFormulario() {
  document.getElementById("form-container").classList.remove("hidden");
}

function cerrarFormulario() {
  document.getElementById("form-container").classList.add("hidden");

  // Resetear formulario
  document.getElementById("prod-nombre").value = "";
  document.getElementById("prod-talle").value = "";
  document.getElementById("prod-precio").value = "";
  document.getElementById("prod-stock").value = "";
  document.getElementById("prod-descripcion").value = "";
  document.getElementById("prod-imagen").value = "";

  productoEditandoId = null; // üî• salir del modo edici√≥n
}

async function guardarProducto() {
  const formData = new FormData();
  formData.append("nombre", document.getElementById("prod-nombre").value);
  formData.append("talle", document.getElementById("prod-talle").value);
  formData.append("precio", document.getElementById("prod-precio").value);
  formData.append("stock", document.getElementById("prod-stock").value);
  formData.append("descripcion", document.getElementById("prod-descripcion").value);
  formData.append("marcaId", marcaId);

  const imagen = document.getElementById("prod-imagen").files[0];
  if (imagen) formData.append("imagen", imagen);

  if (productoEditandoId) {
    // üî• MODO EDITAR
    await fetch(`${API}/productos/${productoEditandoId}`, {
      method: "PUT",
      body: formData
    });
  } else {
    // üî• MODO CREAR
    await fetch(`${API}/productos`, {
      method: "POST",
      body: formData
    });
  }

  cerrarFormulario();
  cargarProductos();
}

async function editarProducto(id) {
  const res = await fetch(`${API}/productos/${id}`);
  const producto = await res.json();

  productoEditandoId = id;

  document.getElementById("prod-nombre").value = producto.nombre;
  document.getElementById("prod-talle").value = producto.talle;
  document.getElementById("prod-precio").value = producto.precio;
  document.getElementById("prod-stock").value = producto.stock;
  document.getElementById("prod-descripcion").value = producto.descripcion || "";

  abrirFormulario();
}

async function eliminarProducto(id) {
  if (!confirm("¬øEliminar producto?")) return;

  await fetch(`${API}/productos/${id}`, {
    method: "DELETE"
  });

  cargarProductos();
}

</script>

</body>
</html>